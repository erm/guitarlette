{% extends 'base.html' %}

{% block extra_head %}
<script src="{{ url_for('static', path='reconnecting-websocket.min.js') }}" type="text/javascript"></script>
{% endblock extra_head %}

{% block content %}
<h1>composer</h1>
{% if song %}
    <strong>created</strong>: {{ song.created_at.strftime('%Y-%m-%d-%HH-%MM-%SS') }} <strong>updated</strong>: {{ song.updated_at.strftime('%Y-%m-%d-%H-%M-%S') }}<br>
{% endif %}


title: <input class="editor-input" type="text" id="editor-title" value="{{ song.title if song else 'untitled' }}">
artist: <input class="editor-input" type="text" id="editor-artist" value="{{ song.artist if song else 'nobody' }}">
<br>
content: <textarea rows="50" cols="100" class="editor-textarea" id="editor-content">{{ song.content if song else ''}}</textarea>


<button onClick="saveSong()">save</button>{% if song %} | <button onclick="deleteSong()">delete</button>{% endif %}

<br>
<input id="transpose-degree" value="1"></input>
<button onClick="transposeSong()">transpose</button>
<br>
scrolling:
<br>
<button onClick="startScrolling()">start</button>
<button onClick="toggleScrolling()">pause / unpause</button>
<button onClick="stopScrolling()">stop</button>
<br>

font size:
<br>
<button onClick="updateFontSize('+')">+</button>
<button onClick="updateFontSize('-')">-</button>


<div id="chord-header">
    {% if song %}
        {% for chord in song.chords %}
            <span class="chord" {{ chord }}> {{ chord }}</span>
        {% endfor %}
    {% endif %}
</div>

<div id="viewer">
    <div id="viewer-content">{% if song %}{{ song.html|safe }}{% endif %}</div>
</div>

<script>
    const ws_url = "{{ WEBSOCKET_URL }}"
    const songId = {% if song %}{{ song.id }}{% else %}null{% endif %}
    const viewer = document.getElementById("viewer")
    const viewerContent = document.getElementById("viewer-content")
    const chordHeader = document.getElementById("chord-header")
    const editorContent = document.getElementById("editor-content")
    const editorTitle = document.getElementById("editor-title")
    const editorArtist = document.getElementById("editor-artist")
    
    var ws = new ReconnectingWebSocket(ws_url);
    var scroller = null
    var scrollPaused = false


    ws.onmessage = function(msg) {
        data = JSON.parse(msg.data)
        if (data.type == "song.redirect") {
            window.location = data.redirect_url
        }
        if (data.type == "song.parser") {
            viewerContent.innerHTML = data.viewer_content
            editorContent.value = data.editor_content
            initEventListeners()
        }
        if (data.type == "chord.hover") {
            console.log(data)
        }
    }

    function startScrolling() {
        var topPos = viewer.offsetTop
        stopScrolling()
        scroll(topPos)
    }

    function stopScrolling() {
        clearInterval(scroller)
    }

    function toggleScrolling() {
        scrollPaused = scrollPaused ? false : true
    }

    function scroll(topPos) {
        viewer.scrollTop = topPos - viewerContent.offsetTop
        scroller = setInterval(function() { 
            if(!scrollPaused) {
                viewer.scrollTop += 4
            }
        }, 500)
    }

    function getCurrentFontSize() {
        return parseInt(window.getComputedStyle(viewerContent, null).getPropertyValue('font-size'))
    }

    function updateFontSize(op) {
        var fontSize = getCurrentFontSize()
        if (op == "-")
            fontSize -= 5
        else
            fontSize += 5
        viewerContent.style.fontSize = fontSize.toString()+"px"
    }

    function saveSong() {
        var type = songId === null ? "song.create" : "song.update"
        ws.send(JSON.stringify({
            "type": type,
            "id": songId,
            "title": editorTitle.value,
            "content": editorContent.value,
            "artist": editorArtist.value
        }))
    }

    function deleteSong() {
        var confirmation = confirm("Are you sure you want to delete this song?")
        if (confirmation)
            ws.send(JSON.stringify({
                "type": "song.delete",
                "id": songId,
            }))
    }

    function transposeSong() {
        degree = document.getElementById("transpose-degree").value
        ws.send(JSON.stringify({
            "type": "song.transpose",
            "content": editorContent.value,
            "degree": degree
        }))
    }

    // function getChordFingering(chord) {

    // }

    function onChordHover(e) {
        var chord = e.srcElement.innerHTML
        ws.send(JSON.stringify({
            "type": "chord.hover",
            "chord": chord,
            "variation": 1
        }))
    }

    function initEventListeners() {
        var chordSpans = document.getElementsByClassName("chord")
        for (var i = 0; i < chordSpans.length; i++) {
            var chordSpan = chordSpans[i]
            chordSpan.addEventListener('mouseover', onChordHover)
        }
    }

    initEventListeners()


</script>
{% endblock content %}