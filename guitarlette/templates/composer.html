{% extends 'base.html' %}

{% block extra_head %}
<script src="{{ url_for('static', path='reconnecting-websocket.min.js') }}" type="text/javascript"></script>
{% endblock extra_head %}

{% block content %}

<h1>composer</h1>



{% if song %}
    <strong>Created</strong>: {{ song.created_at.strftime('%Y-%m-%d-%HH-%MM-%SS') }} <strong>Updated</strong>: {{ song.updated_at.strftime('%Y-%m-%d-%H-%M-%S') }}<br>
{% endif %}


<div class="container is-fluid">
    <div class="notification">
        <div class="field">
            <label class="label">title</label>
            <div class="control">
                <input class="input" type="text" id="editor-title" value="{{ song.name if song else 'untitled' }}">
            </div>
        </div>
        <div class="field">
            <label class="label">content</label>
            <div class="control">
                <textarea class="textarea" id="editor-content">{{ song.content if song else ''}}</textarea>
            </div>
        </div>
        <div class="field is-grouped">
            <div class="control">
                <button class="button is-link" onClick="updateSong()">save</button>>
            </div>
            <div class="control">
                <button class="button is-text">Cancel</button>
            </div>
        </div>
    </div>
</div>


{% if song %}
<button 
<button onclick="deleteSong()">delete</button>
{% else %}
<button onClick="createSong()">save</button>
{% endif %}

<br>
<input id="transpose-degree" value="1"></input>
<button onClick="transposeSong()">Transpose</button>
<br>
Scrolling:
<br>
<button onClick="startScrolling()">Start</button>
<button onClick="toggleScrolling()">Pause / Unpause</button>
<button onClick="stopScrolling()">Stop</button>
<br>

Font Size:
<br>
<button onClick="updateFontSize('+')">+</button>
<button onClick="updateFontSize('-')">-</button>


<div id="chord-header">
    {% if song %}
    {% for chord in song.chords %}
    <span class="chord" {{ chord }}> {{ chord }}</span>
    {% endfor %}
    {% endif %}
</div>

<div id="viewer">
    <div id="viewer-content">{% if song %}{{ song.html|safe }}{% endif %}</div>
</div>

<script>
    const ws_url = "{{ WEBSOCKET_URL }}"
    const songId = {% if song %}{{ song.id }}{% else %}null{% endif %}
    const viewer = document.getElementById("viewer")
    const viewerContent = document.getElementById("viewer-content")
    const chordHeader = document.getElementById("chord-header")
    const editorContent = document.getElementById("editor-content")
    const editorTitle = document.getElementById("editor-title")
    // const editorArtist = document.getElementById("editor-artist")
    
    var ws = new ReconnectingWebSocket(ws_url);
    var scroller = null
    var scrollPaused = false


    ws.onmessage = function(msg) {
        data = JSON.parse(msg.data)
        if (data.type == "song.redirect") {
            window.location = data.redirect_url
        }
        if (data.type == "song.parser") {
            viewerContent.innerHTML = data.viewer_content
            editorContent.value = data.editor_content
            initEventListeners()
        }
        if (data.type == "chord.hover") {
            console.log(data)
        }
    }

    function startScrolling() {
        var topPos = viewer.offsetTop
        stopScrolling()
        scroll(topPos)
    }

    function stopScrolling() {
        clearInterval(scroller)
    }

    function toggleScrolling() {
        scrollPaused = scrollPaused ? false : true
    }

    function scroll(topPos) {
        viewer.scrollTop = topPos - viewerContent.offsetTop
        scroller = setInterval(function() { 
            if(!scrollPaused) {
                viewer.scrollTop += 4
            }
        }, 500)
    }

    function getCurrentFontSize() {
        return parseInt(window.getComputedStyle(viewerContent, null).getPropertyValue('font-size'))
    }

    function updateFontSize(op) {
        var fontSize = getCurrentFontSize()
        if (op == "-")
            fontSize -= 5
        else
            fontSize += 5
        viewerContent.style.fontSize = fontSize.toString()+"px"
    }

    function createSong() {
        ws.send(JSON.stringify({
            "type": "song.create",
            "title": editorTitle.value,
            "content": editorContent.value,
            // "artist": editorArtist.value
        }))
    }

    function updateSong() {
        ws.send(JSON.stringify({
            "type": "song.update",
            "id": songId,
            "title": editorTitle.value,
            "content": editorContent.value,
            // "artist": editorArtist.value
        }))
    }

    function deleteSong() {
        var confirmation = confirm("Are you sure you want to delete this song?")
        if (confirmation)
            ws.send(JSON.stringify({
                "type": "song.delete",
                "id": songId,
            }))
    }

    function transposeSong() {
        degree = document.getElementById("transpose-degree").value
        ws.send(JSON.stringify({
            "type": "song.transpose",
            "content": editorContent.value,
            "degree": degree
        }))
    }

    // function getChordFingering(chord) {

    // }

    function onChordHover(e) {
        var chord = e.srcElement.innerHTML
        ws.send(JSON.stringify({
            "type": "chord.hover",
            "chord": chord,
            "variation": 1
        }))
    }

    function initEventListeners() {
        var chordSpans = document.getElementsByClassName("chord")
        for (var i = 0; i < chordSpans.length; i++) {
            var chordSpan = chordSpans[i]
            chordSpan.addEventListener('mouseover', onChordHover)
        }
    }

    initEventListeners()


</script>
{% endblock content %}